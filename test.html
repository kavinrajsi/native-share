<!-- [Attributes by Finsweet] Social Share -->
<script defer src="https://cdn.jsdelivr.net/npm/@finsweet/attributes-socialshare@1/socialshare.js"></script>
<!-- Add Firebase SDK -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-storage-compat.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
<script>
        // Initialize Firebase with your config
        const firebaseConfig = {
            apiKey: "AIzaSyD-vsblELU17PZm2er8B8Lkbo2QQg_07WM",
            authDomain: "certificate-91b26.firebaseapp.com",
            projectId: "certificate-91b26",
            storageBucket: "certificate-91b26.appspot.com",
            messagingSenderId: "918378444843",
            appId: "1:918378444843:web:e28d2b80e038ddf13f926e",
            measurementId: "G-Z2H7XV1FN7"
        };
        firebase.initializeApp(firebaseConfig);

        // Function to get query parameter by name
        function getQueryParameter(name) {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get(name);
        }

        // Function to update meta tags
        function updateMetaTags(imageUrl) {
            let ogImage = document.getElementById('ogImage');
            if (ogImage) {
                ogImage.setAttribute('content', imageUrl);
                console.log('Updated Open Graph meta tag with new image URL:', imageUrl);
            } else {
                console.error('Open Graph meta tag with specified ID not found.');
            }
        }

        async function captureAndUploadScreenshot(name) {
    try {
        const content = document.getElementById("content");
        const scale = 1080 / content.offsetWidth;
        const canvas = await html2canvas(content, {
            scale: scale,
            useCORS: true,
            allowTaint: true
        });

        const imgData = canvas.toDataURL('image/png');
        const blob = await fetch(imgData).then(res => res.blob());
        const filename = `certificate_of_${name}_${Date.now()}.png`;
        const storageRef = firebase.storage().ref();
        const uploadTask = storageRef.child(filename).put(blob);

        await uploadTask;
        console.log('Screenshot uploaded successfully');

        const url = await storageRef.child(filename).getDownloadURL();
        console.log('Image URL from Firebase Storage:', url);
        updateMetaTags(url);

        // Ensure global variables are set
        window.imageUrl = url;
        window.imageFilename = filename;

        // Enable download button
        document.getElementById("downloadBtn").disabled = false;

        document.getElementById("shareFacebook").addEventListener("click", () => {
            const shareUrl = `https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(url)}`;
            window.open(shareUrl, "_blank");
        });

        document.getElementById("shareTwitter").addEventListener("click", () => {
            const shareUrl = `https://twitter.com/intent/tweet?url=${encodeURIComponent(url)}`;
            window.open(shareUrl, "_blank");
        });

        document.getElementById("shareLinkedIn").addEventListener("click", () => {
            const shareUrl = `https://www.linkedin.com/sharing/share-offsite/?url=${encodeURIComponent(url)}`;
            window.open(shareUrl, "_blank");
        });

    } catch (error) {
        console.error('Error in capturing or uploading screenshot:', error);
    }
}


        // Function to check if all images are loaded
        function imagesLoaded() {
            const images = document.querySelectorAll("#content img");
            return Array.from(images).every(img => img.complete);
        }

        // Display the name and trigger the screenshot capture
        document.addEventListener("DOMContentLoaded", () => {
            const name = getQueryParameter('name');
            if (name) {
                document.getElementById("result").textContent = decodeURIComponent(name);

                // Wait for all images inside #content to load
                const checkInterval = setInterval(() => {
                    if (imagesLoaded()) {
                        clearInterval(checkInterval);
                        captureAndUploadScreenshot(name);
                    }
                }, 100);

                // Download button event listener
                document.getElementById("downloadBtn").addEventListener("click", async () => {
                    const storageRef = firebase.storage().ref();

      window.imageFilename = "certificate_of_kavinraj_1716573494522.png";
      storageRef
        .child(window.imageFilename)
        .getDownloadURL()
        .then((url) => {
          document
            .getElementById("download-image")
            .addEventListener("click", function (event) {
              event.preventDefault(); // Prevent default anchor behavior
              console.log(url);
              document.getElementById("share-image").src = url; // Set the src attribute of the image
            });
        })
        .catch((error) => {
          console.error("Error getting download URL: ", error);
        });
                    // try {
                    //     if (window.imageUrl && window.imageFilename) {
                    //         const storageRef = firebase.storage().ref();
                    //         const url = await storageRef.child(window.imageFilename).getDownloadURL();
                    //         const response = await fetch(url);
                    //         const blob = await response.blob();
                    //         saveAs(blob, window.imageFilename);
                    //     } else {
                    //         console.error('Image URL or filename is not available.');
                    //     }
                    // } catch (error) {
                    //     console.error('Error getting download URL:', error);
                    // }
                });
            } else {
                console.error('Name query parameter is missing.');
            }
        });


        // NOTE: 
        // get the img url from server -- done -- 
        // append the img to html -- done --
        // download the image
    </script>